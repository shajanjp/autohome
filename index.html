<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Auto Home</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/semantic-ui/2.2.1/semantic.min.css">
	<style>
	#device-list .device,
	#device-list .device img,
	#device-dashboard .segment,
	#device-dashboard .button,
	#device-dashboard .input input{
		border-radius: 0px;
	}
</style>
</head>
<body>
	<br>
	<div class="ui container" id="device-dashboard">
		<div class="ui input">
			<input type="text" id="mcuip" placeholder="Micro controller IP">
		</div>
		<button class="ui primary labeled icon button" id="connect-device"><i class="refresh icon"></i>Connect Device</button>
		<div class="ui segments">
			<div class="ui segment">
				<h3 class="ui header">AutoHome Devices</h3>
			</div>
			<div class="ui segment">
				<div class="ui five stackable cards" id="device-list">

					<!-- Device 1 -->
					<div class="card device" data-device="1" data-state="0" id="device-1">
						<div class="image">
							<img src="device.jpg">
						</div>
						<div class="content">
							<div class="header" contenteditable>Device 1</div>
							<div class="meta">
								<a>GPIO 14</a>
							</div>
						</div>
						<div class="extra content">
							<span class="right floated">
								<i class="red circle icon switch"></i>
							</span>
							<span class="right floated">
								<i class="grey circle icon toggle"></i>
							</span>
						</div>
					</div>

					<!-- Device 2 -->
					<div class="card device" data-device="2" data-state="0" id="device-2">
						<div class="image">
							<img src="device.jpg">
						</div>
						<div class="content">
							<div class="header" contenteditable>Device 2</div>
							<div class="meta">
								<a>GPIO 12</a>
							</div>
						</div>
						<div class="extra content">
							<span class="right floated">
								<i class="red circle icon switch"></i>
							</span>
							<span class="right floated">
								<i class="grey circle icon toggle"></i>
							</span>
						</div>
					</div>

					<!-- Device 3 -->
					<div class="card device" data-device="3" data-state="0" id="device-3">
						<div class="image">
							<img src="device.jpg">
						</div>
						<div class="content">
							<div class="header" contenteditable>Device 3</div>
							<div class="meta">
								<a>GPIO 13</a>
							</div>
						</div>
						<div class="extra content">
							<span class="right floated">
								<i class="red circle icon switch"></i>
							</span>
							<span class="right floated">
								<i class="grey circle icon toggle"></i>
							</span>
						</div>
					</div>

					<!-- Device 4 -->
					<div class="card device" data-device="4" data-state="0" id="device-4">
						<div class="image">
							<img src="device.jpg">
						</div>
						<div class="content">
							<div class="header" contenteditable>Device 4</div>
							<div class="meta">
								<a>GPIO 15</a>
							</div>
						</div>
						<div class="extra content">
							<span class="right floated">
								<i class="red circle icon switch"></i>
							</span>
							<span class="right floated">
								<i class="grey circle icon toggle"></i>
							</span>
						</div>
					</div>

					<!-- Device 5 -->
					<div class="card device" data-device="5" data-state="0" id="device-5">
						<div class="image">
							<img src="device.jpg">
						</div>
						<div class="content">
							<div class="header" contenteditable>Device 5</div>
							<div class="meta">
								<a>GPIO 3</a>
							</div>
						</div>
						<div class="extra content">
							<span class="right floated">
								<i class="red circle icon switch"></i>
							</span>
							<span class="right floated">
								<i class="grey circle icon toggle"></i>
							</span>
						</div>
					</div>

				</div>
			</div>
		</div>
		<button class="ui primary labeled icon button" id="check-device-status"><i class="refresh icon"></i>Check Status</button>
		<button class="ui basic red labeled icon button" id="turn-off-devices"><i class="circle icon"></i>Switch OFF Devices</button>
	</div>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/semantic-ui/2.2.1/semantic.min.js"></script>
	<script>

		var toggleBlink = function(device){
			device.find('.toggle').removeClass('grey').addClass('yellow');
			setTimeout(function(){
				device.find('.toggle').removeClass('yellow').addClass('grey');
			}, 500);
			setTimeout(function(){
				device.find('.toggle').removeClass('grey').addClass('yellow');
			}, 1000);
			setTimeout(function(){
				device.find('.toggle').removeClass('yellow').addClass('grey');
			}, 1500);
			setTimeout(function(){
				device.find('.toggle').removeClass('grey').addClass('yellow');
			}, 2000);
			setTimeout(function(){
				device.find('.toggle').removeClass('yellow').addClass('grey');
			}, 2500);
		}

		var makeSwitch = function(sno, state){
			var device = $('#device-' + sno);
			if(state == "0"){
				device.find('.switch').removeClass('green').addClass('red');
				device.find('.toggle').removeClass('yellow').addClass('grey');
				device.data('state', "0");
			}
			else if(state == "1"){
				device.find('.switch').removeClass('red').addClass('green');
				device.data('state', "1");
			}
			else if(state == "2"){
				toggleBlink(device);
			}
		}

		var nextState = function(current_state){
			if (current_state == 1) 
				return 0;
			else
				return 1;
		}

		var checkDeviceStatus = function(){
			$.get("http://" + $('#mcuip').val() + "/devices", function(data) {
				alert("hello");
				data.forEach(function(d){
					makeSwitch(d.device, d.status);
				});
			});
		}

		// checkDeviceStatus();
		$('.switch').on('click', function(){
			let current_device = $(this).closest('.device');
			let data = {};
			data.device = current_device.data('device');
			data.status = nextState(current_device.data('state'));
			$.get("http://" + $('#mcuip').val() + "/devices", data, function(response){
				makeSwitch(response.device, response.state);
			});
		});

		$('.toggle').on('click', function(){
			let current_device = $(this).closest('.device');
			let data = {};
			data.device = current_device.data('device');
			data.status = 2;
			makeSwitch(data.device, data.status);
			$.get("http://" + $('#mcuip').val() + "/devices", data, function(response){
				makeSwitch(response.device, response.state);
			});
		});

		$('#check-device-status').on('click', function(){
			checkDeviceStatus();
		});

		$('#connect-device').on('click', function(){
			$.get("http://" + $('#mcuip').val() + "/devices", function(data) {
				if(data){
					data.forEach(function(d){
						makeSwitch(d.device, d.status);
					});
					$('#connect-device').removeClass('primary').addClass('green').html('<i class="refresh icon"></i>Connected');
				}
			});
		});

		$('#turn-off-devices').on('click', function(){
			$.get("http://" + $('#mcuip').val() + "/devices?device=all&status=0", function(data) {
				data.forEach(function(d){
					makeSwitch(d.device, d.status);
				});
			});
		});

	</script>
</body>
</html>